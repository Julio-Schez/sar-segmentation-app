<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo con Flask</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    {% if alert_message %}
    <div id="alert" class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;">
        {{ alert_message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endif %}
    <div id="map-container">
        <div id="sidebar">
            <button id="toggle-sidebar" class="btn btn-primary"><i class="fas fa-bars"></i></button>
            <form action="/" method="post" enctype="multipart/form-data" id="uploadForm">
                <div class="form-group">
                    <label for="file" class="form-label">Subir Imagen Satelital (TIFF) o Archivo SHP</label>
                    <input type="file" id="file" name="file" multiple accept=".tiff,.tif,.shp,.dbf,.shx,.prj,.TIFF,.TIF,.SHP,.DBF,.SHX,.PRJ" class="form-control mb-2">
                    <small class="form-text text-muted">
                        - Para shapefiles, seleccione todos los archivos asociados (.shp, .dbf, .shx, .prj)<br>
                        - Para segmentación de inundaciones, use imágenes Sentinel-1
                    </small>
                </div>
                <button type="submit" class="btn btn-success w-100 mb-3">
                    <i class="fas fa-upload"></i> Subir
                </button>
            </form>

            <!-- Contenedor para los botones de acción -->
            <div id="action-buttons">
                <!-- Botón de segmentación (inicialmente deshabilitado) -->
                <button id="segment-button" class="btn btn-info w-100 mb-3" disabled>
                    <i class="fas fa-wand-magic-sparkles"></i> Segmentar Inundaciones
                </button>
                
                <!-- Botón de limpiar mapa -->
                <button id="clear-map" class="btn btn-danger w-100 mb-3">
                    <i class="fas fa-trash-alt"></i> Limpiar Mapa
                </button>
            </div>

            <!-- Lista de capas cargadas -->
            <div id="layers-list" class="mt-3">
                <h6 class="mb-2">Capas Cargadas:</h6>
                <ul class="list-group" id="loaded-layers">
                    <!-- Las capas se añadirán aquí dinámicamente -->
                </ul>
            </div>
        </div>
        {{ folium_map | safe }}
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleButton = document.getElementById('toggle-sidebar');
            const sidebar = document.getElementById('sidebar');
            const fileInput = document.getElementById('file');
            const segmentButton = document.getElementById('segment-button');
            const layersList = document.getElementById('loaded-layers');
            const uploadForm = document.getElementById('uploadForm');

            // Toggle sidebar
            toggleButton.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
            });

            // Manejar cambios en la selección de archivos
            fileInput.addEventListener('change', function() {
                const files = Array.from(this.files);
                const hasSentinel1 = files.some(file => 
                    file.name.toLowerCase().includes('sentinel1') || 
                    file.name.toLowerCase().includes('sentinel-1')
                );
                
                // Actualizar estado del botón de segmentación
                segmentButton.disabled = !hasSentinel1;
                segmentButton.title = hasSentinel1 ? 
                    'Segmentar inundaciones' : 
                    'Solo disponible para imágenes Sentinel-1';

                // Actualizar lista de capas
                layersList.innerHTML = '';
                files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    const isSentinel = file.name.toLowerCase().includes('sentinel1') || 
                                     file.name.toLowerCase().includes('sentinel-1');
                    li.innerHTML = `
                        ${file.name}
                        ${isSentinel ? 
                            '<span class="badge badge-info">Sentinel-1</span>' : 
                            '<span class="badge badge-secondary">Otro</span>'}
                    `;
                    layersList.appendChild(li);
                });
            });

            // Manejar envío del formulario
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                // Verificar si hay archivos seleccionados
                if (fileInput.files.length === 0) {
                    alert('Por favor, seleccione al menos un archivo.');
                    return;
                }

                // Mostrar indicador de carga
                const submitButton = uploadForm.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

                fetch('/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                    location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                    alert('Error al procesar los archivos');
                });
            });

            // Manejar clic en botón de segmentación
            segmentButton.addEventListener('click', function(e) {
                e.preventDefault();

                // Mostrar indicador de carga
                const originalText = this.innerHTML;
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

                fetch('/segment', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.error || 'Error al procesar la imagen');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al procesar la solicitud');
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = originalText;
                });
            });

            // Manejar clic en botón de limpiar
            document.getElementById('clear-map').addEventListener('click', function() {
                if (confirm('¿Está seguro de que desea limpiar el mapa?')) {
                    // Mostrar indicador de carga
                    const originalText = this.innerHTML;
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Limpiando...';

                    fetch('/clear', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error al limpiar el mapa: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al procesar la solicitud');
                    })
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalText;
                    });
                }
            });

            // Manejar alertas
            const alertElement = document.getElementById('alert');
            if (alertElement) {
                setTimeout(function() {
                    alertElement.classList.remove('show');
                    setTimeout(() => alertElement.remove(), 300);
                }, 5000);
            }
        });
    </script>
</body>
</html>
